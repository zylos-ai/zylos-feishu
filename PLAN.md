# zylos-feishu æ”¹è¿›è®¡åˆ’

**æ—¥æœŸ**: 2026-02-15
**å‚ä¸è€…**: Howard (å†³ç­–), cococlaw (åˆ†æ+æ‰§è¡Œ)
**çŠ¶æ€**: å¾…ç¡®è®¤åæ‰§è¡Œ

---

## å†³è®®æ€»è§ˆ

| # | æ”¹è¿›é¡¹ | å†³è®® | ä¼˜å…ˆçº§ | çŠ¶æ€ |
|---|--------|------|--------|------|
| 1 | Lark/Feishu åŸŸååˆ‡æ¢ | âŒ ä¸åš â€” æ•…æ„ç¡¬ç¼–ç ï¼Œlark/feishu åˆ†ä»“åº“ | - | å…³é—­ |
| 2 | æ¶ˆæ¯å»é‡ç»Ÿä¸€ | âœ… ä¸¤ç§æ¨¡å¼éƒ½è¦å»é‡ | P0 | å¾…æ‰§è¡Œ |
| 3 | å›å¤å¼•ç”¨ (Reply Threading) | âœ… åŒæ„ï¼Œéœ€å…¼å®¹ C4 åè®® | P0 | å¾…ç¡®è®¤æ–¹æ¡ˆ |
| 4 | Post å›¾ç‰‡éå† | âœ… éå†æ‰€æœ‰ image_keyï¼Œæ‡’ä¸‹è½½ | P0 | å¾…æ‰§è¡Œ |
| 5 | Streaming Card å›å¤ | âŒ æš‚ä¸åš â€” æ¶‰åŠ C4 é‡å¤§æ”¹åŠ¨ï¼ŒClaude Code æ”¯æŒæœªç¡®è®¤ | - | æ¨è¿Ÿ |
| 6 | Markdown Card å‘é€ | âœ… è‡ªåŠ¨æ£€æµ‹å†³å®šç”¨ text è¿˜æ˜¯ card | P1 | å¾…æ‰§è¡Œ |
| 7 | ç¾¤èŠå†å²ä¸Šä¸‹æ–‡ä¼˜åŒ– | âœ… æ”¹å†…å­˜ Map + limit capï¼Œä¿ç•™æ–‡ä»¶æ—¥å¿— | P1 | å¾…æ‰§è¡Œ |
| 8 | å‘é€è€…åç§°ç¼“å­˜ä¼˜åŒ– | âœ… åŠ  TTLï¼Œå†…å­˜ç¼“å­˜ä¸ºä¸» | P1 | å¾…æ‰§è¡Œ |
| 9 | ç¾¤ç»„çº§åˆ«ç²¾ç»†é…ç½® | âœ… åŒæ„ï¼Œéœ€å‘ä¸‹å…¼å®¹åˆ†æ + è¯é¢˜å›å¤ä¿®å¤ | P1 | å¾…ç¡®è®¤æ–¹æ¡ˆ |
| 10 | @mention è½¬å‘ | âŒ ä¸åš â€” ä¸åº”é»˜è®¤ at åŸæ¶ˆæ¯ä¸­çš„å…¶ä»–äºº | - | å…³é—­ |
| 11 | æƒé™é”™è¯¯è‡ªåŠ¨æç¤º | âœ… å‚è€ƒ OpenClaw åŠ ä¸Š | P2 | å¾…æ‰§è¡Œ |
| 12 | Typing Indicator | âœ… å‚è€ƒ OpenClaw åŠ ä¸Šï¼Œéœ€è€ƒè™‘è¶…æ—¶ | P2 | å¾…æ‰§è¡Œ |
| 13 | åŠ¨æ€ Agent åˆ›å»º | âŒ æš‚ä¸è€ƒè™‘ | - | æ¨è¿Ÿ |
| 14 | æ¶ˆæ¯åˆ†å—ä¼˜åŒ– | âœ… å‚è€ƒ OpenClaw ä¼˜åŒ– | P1 | å¾…æ‰§è¡Œ |

---

## éœ€è¦è¿›ä¸€æ­¥è®¨è®ºçš„é¡¹ç›®

### #3 å›å¤å¼•ç”¨ + #9 è¯é¢˜å›å¤ â€” ç»Ÿä¸€æ–¹æ¡ˆï¼ˆåˆ©ç”¨ endpoint å¯æ‰©å±•æ€§ï¼‰

**æ ¸å¿ƒæ´å¯Ÿ**ï¼ˆHoward æŒ‡å‡ºï¼‰ï¼šC4 çš„ `--endpoint` æ˜¯ä¸€ä¸ªä¸é€æ˜å­—ç¬¦ä¸²ï¼ŒC4 åªåšé€ä¼ ï¼Œå†…éƒ¨æ ¼å¼å®Œå…¨ç”±ç»„ä»¶è‡ªå®šä¹‰ã€‚å¯ä»¥ç”¨ flagsã€JSONã€åˆ†éš”ç¬¦ç­‰ä»»ä½•æ ¼å¼ç¼–ç å…ƒæ•°æ®ã€‚

**æ–¹æ¡ˆï¼šç»“æ„åŒ– endpoint**

endpoint æ ¼å¼ä»å•çº¯çš„ `chatId` å‡çº§ä¸ºå¸¦å…ƒæ•°æ®çš„ç»“æ„åŒ–å­—ç¬¦ä¸²ï¼š

```
chatId|root:om_root_xxx|reply:om_msg_xxx
```

ç”¨ `|` ä½œä¸ºåˆ†éš”ç¬¦ï¼ˆé£ä¹¦ ID ä¸å« `|`ï¼‰ï¼Œæ¯ä¸ª segment æ˜¯ `key:value` æ ¼å¼ã€‚

**å…¥ç«™ (index.js â†’ c4-receive)**ï¼š
```javascript
// æ„å»ºç»“æ„åŒ– endpoint
let endpoint = chatId;
if (message.root_id) {
  endpoint += `|root:${message.root_id}`;
}
// è§¦å‘æ¶ˆæ¯çš„ message_idï¼Œç”¨äºå›å¤æ—¶ reply_to
endpoint += `|msg:${messageId}`;

// è°ƒç”¨ C4
sendToC4('feishu', endpoint, formattedMessage);
```

C4 æŠŠæ•´ä¸ª endpoint å­—ç¬¦ä¸²åŸæ ·ä¿å­˜ï¼ŒåŸæ ·ä¼ ç»™ `reply via` åç¼€ â†’ Claude å›å¤æ—¶è°ƒç”¨ c4-send â†’ c4-send åŸæ ·é€ä¼ ç»™ send.jsã€‚

**å‡ºç«™ (send.js)**ï¼š
```javascript
// è§£æç»“æ„åŒ– endpoint
const parts = endpointId.split('|');
const chatId = parts[0];
const meta = {};
for (const part of parts.slice(1)) {
  const [key, value] = part.split(':');
  meta[key] = value;
}
// meta = { root: "om_root_xxx", msg: "om_msg_xxx" }

if (meta.root) {
  // è¯é¢˜å†…å›å¤ï¼šreply åˆ° root messageï¼Œé£ä¹¦ä¼šè‡ªåŠ¨å½’å…¥è¯¥ thread
  await replyToMessage(meta.root, text);   // im.message.reply API
} else if (meta.msg) {
  // æ™®é€šå›å¤ï¼šreply åˆ°è§¦å‘æ¶ˆæ¯
  await replyToMessage(meta.msg, text);
} else {
  // fallbackï¼šç›´æ¥å‘é€åˆ°ç¾¤ï¼ˆå‘ä¸‹å…¼å®¹æ—§çš„çº¯ chatId endpointï¼‰
  await sendToGroup(chatId, text);
}
```

**å…¥ç«™ content é‡Œçš„å¼•ç”¨ä¸Šä¸‹æ–‡**ï¼š
å¦‚æœæ¶ˆæ¯æœ‰ `parent_id`ï¼ˆç”¨æˆ·å¼•ç”¨äº†æŸæ¡æ¶ˆæ¯ï¼‰ï¼Œfetch è¢«å¼•ç”¨æ¶ˆæ¯å†…å®¹ï¼Œæ‹¼å…¥ contentï¼š
```
[Feishu GROUP] Howard said: [Replying to: "è¢«å¼•ç”¨çš„æ¶ˆæ¯å†…å®¹"] ç”¨æˆ·çš„æ–°æ¶ˆæ¯
```
è¿™æ · Claude èƒ½ç†è§£å¼•ç”¨ä¸Šä¸‹æ–‡ã€‚

**å‘ä¸‹å…¼å®¹**ï¼š
- å¦‚æœ endpoint ä¸å« `|`ï¼Œsend.js æŒ‰æ—§é€»è¾‘èµ° `sendToGroup(chatId, text)`
- é›¶ C4 æ”¹åŠ¨

**è¦†ç›–åœºæ™¯**ï¼š
| åœºæ™¯ | endpoint ç¤ºä¾‹ | send.js è¡Œä¸º |
|------|--------------|-------------|
| ç¾¤ä¸»æ¶ˆæ¯æµ | `oc_xxx\|msg:om_123` | reply åˆ° om_123 |
| è¯é¢˜å†…æ¶ˆæ¯ | `oc_xxx\|root:om_456\|msg:om_789` | reply åˆ° om_456ï¼ˆå½’å…¥è¯é¢˜ï¼‰ |
| DM | `oc_xxx\|msg:om_abc` | reply åˆ° om_abc |
| æ—§æ ¼å¼(å…¼å®¹) | `oc_xxx` | sendToGroup(oc_xxx) |

---

### #4 Post å›¾ç‰‡æ‡’ä¸‹è½½æ–¹æ¡ˆ

**è®¾è®¡**ï¼š
- `extractPostText()` éå†æ‰€æœ‰ image_keyï¼Œåœ¨æ–‡æœ¬ä¸­æ’å…¥å ä½æ ‡è®° `[image, image_key: xxx, msg_id: yyy]`
- **ä¸ç«‹å³ä¸‹è½½å›¾ç‰‡**
- åªæœ‰å½“æ¶ˆæ¯éœ€è¦é€ç»™ C4 å¤„ç†æ—¶ï¼ˆDM æˆ–è¢« @mention çš„ç¾¤æ¶ˆæ¯ï¼‰ï¼Œæ‰æ‰¹é‡ä¸‹è½½
- ç¾¤å†…é @mention çš„æ¶ˆæ¯åªè®°å½• image_key å ä½ç¬¦åˆ°æ—¥å¿—ï¼Œä¸ä¸‹è½½

è¿™å·²ç»æ˜¯ç°æœ‰ä»£ç æ¥è¿‘çš„è¡Œä¸ºï¼Œåªéœ€ç¡®ä¿ `extractPostText()` è¿”å›æ‰€æœ‰ imageKeys è€Œéåªå–ç¬¬ä¸€ä¸ªã€‚

---

### #9 ç¾¤ç»„ç²¾ç»†é…ç½® â€” å‘ä¸‹å…¼å®¹åˆ†æ

**å½“å‰é…ç½®ç»“æ„**:
```json
{
  "allowed_groups": [
    {"chat_id": "oc_xxx", "name": "Group A", "added_at": "..."}
  ],
  "smart_groups": [
    {"chat_id": "oc_yyy", "name": "Core", "added_at": "..."}
  ],
  "group_whitelist": { "enabled": true }
}
```

**ç›®æ ‡é…ç½®ç»“æ„**ï¼ˆå‚è€ƒ OpenClawï¼‰:
```json
{
  "groups": {
    "oc_xxx": {
      "name": "Group A",
      "mode": "mention",
      "allowFrom": ["ou_xxx", "ou_yyy"],
      "requireMention": true,
      "historyLimit": 10
    },
    "oc_yyy": {
      "name": "Core",
      "mode": "smart",
      "requireMention": false
    }
  }
}
```

**å‘ä¸‹å…¼å®¹æ–¹æ¡ˆ**:
1. ä»£ç ä¸­åŒæ—¶æ”¯æŒæ–°æ—§ä¸¤ç§æ ¼å¼
2. å¯åŠ¨æ—¶æ£€æµ‹ï¼š
   - å¦‚æœå­˜åœ¨ `groups` å­—æ®µ â†’ ä½¿ç”¨æ–°æ ¼å¼
   - å¦‚æœä¸å­˜åœ¨ä½†æœ‰ `allowed_groups`/`smart_groups` â†’ è‡ªåŠ¨è½¬æ¢ä¸ºæ–°æ ¼å¼å†™å› config
3. `post-upgrade.js` hook ä¸­å¢åŠ è¿ç§»é€»è¾‘ï¼š
   - è¯»å–æ—§ config
   - `allowed_groups` â†’ `groups[chat_id] = { mode: "mention", name, requireMention: true }`
   - `smart_groups` â†’ `groups[chat_id] = { mode: "smart", requireMention: false }`
   - å†™å›æ–° configï¼Œä¿ç•™æ—§å­—æ®µä½œä¸ºå¤‡ä»½ï¼ˆ`_legacy_allowed_groups`ï¼‰
4. admin.js çš„å‘½ä»¤åŒæ­¥æ›´æ–°

**å·²æœ‰é€»è¾‘éœ€ä¿ç•™**ï¼š
- ç®¡ç†å‘˜æ‹‰ bot å…¥ç¾¤ â†’ è‡ªåŠ¨åŠ ç™½ï¼ˆåŠ å…¥ groups é…ç½®ï¼Œmode: "mention"ï¼‰
- éç®¡ç†å‘˜æ‹‰ bot å…¥ç¾¤ â†’ ä¸åŠ ç™½ï¼Œéœ€è¯·æ±‚ç®¡ç†å‘˜å®¡æ‰¹
- è¿™éœ€è¦ç›‘å¬ `im.chat.member.bot.added_v1` äº‹ä»¶ï¼ˆå½“å‰ feishu ä»£ç æœªå®ç°ï¼Œéœ€æ–°å¢ï¼‰
- åˆ¤æ–­ operator æ˜¯å¦ä¸º ownerï¼šæ˜¯ â†’ è‡ªåŠ¨åŠ å…¥ groupsï¼›å¦ â†’ é€šçŸ¥ owner å®¡æ‰¹

**å¯¹è¿ç§»çš„å½±å“**ï¼šæ— å½±å“ã€‚è¿ç§»åªè½¬æ¢å·²æœ‰æ•°æ®æ ¼å¼ï¼Œbot å…¥ç¾¤è‡ªåŠ¨åŠ ç™½æ˜¯è¿è¡Œæ—¶é€»è¾‘ï¼Œä¸è¿ç§»ç‹¬ç«‹ã€‚

---

### #12 Typing Indicator è¶…æ—¶

**æ–¹æ¡ˆ**ï¼š
- æ”¶åˆ°æ¶ˆæ¯åï¼Œåœ¨è¯¥æ¶ˆæ¯ä¸ŠåŠ ä¸€ä¸ª emoji reactionï¼ˆå¦‚ â³ æˆ– ğŸ‘€ï¼‰
- AI å›å¤åç§»é™¤ reaction
- è®¾ç½®æœ€å¤§è¶…æ—¶ï¼ˆå¦‚ 120 ç§’ï¼‰ï¼Œè¶…æ—¶åè‡ªåŠ¨ç§»é™¤ï¼Œé¿å… AI æ— å›å¤æ—¶ä¸€ç›´æŒ‚ç€
- å®ç°ï¼š`setTimeout` + æ ‡è®°ä½ï¼Œå›å¤åˆ°è¾¾æ—¶ clearTimeout

### æ–°å¢ï¼šBot å…¥ç¾¤è‡ªåŠ¨åŠ ç™½

**éœ€æ±‚**ï¼ˆHoward æŒ‡å‡ºï¼Œéœ€ä¿ç•™åŸæœ‰è®¾è®¡æ„å›¾ï¼‰ï¼š
- ç›‘å¬ `im.chat.member.bot.added_v1` äº‹ä»¶
- åˆ¤æ–­æ‹‰ bot å…¥ç¾¤çš„ operatorï¼š
  - æ˜¯ owner â†’ è‡ªåŠ¨å°†è¯¥ç¾¤åŠ å…¥ groups é…ç½®ï¼ˆmode: "mention"ï¼‰ï¼Œä¿å­˜ config
  - é owner â†’ ä¸åŠ ç™½ï¼Œé€šçŸ¥ ownerï¼ˆé€šè¿‡ C4 å‘ç³»ç»Ÿæ¶ˆæ¯ï¼‰è¯·æ±‚å®¡æ‰¹
- ç›‘å¬ `im.chat.member.bot.deleted_v1` äº‹ä»¶ï¼šbot è¢«ç§»å‡ºç¾¤ â†’ ä» groups ä¸­ç§»é™¤

---

## æ‰§è¡Œé¡ºåº

ç¡®è®¤å®Œæ‰€æœ‰æ–¹æ¡ˆåï¼ŒæŒ‰ä»¥ä¸‹é¡ºåºæ‰§è¡Œï¼š

**ç¬¬ä¸€æ³¢ (P0)** â€” åŸºç¡€åŠŸèƒ½ä¿®å¤:
1. æ¶ˆæ¯å»é‡ç»Ÿä¸€ (#2)
2. ç»“æ„åŒ– endpoint + è¯é¢˜å›å¤ä¿®å¤ + å›å¤å¼•ç”¨ (#3 + #9 thread)
3. Post å›¾ç‰‡éå†+æ‡’ä¸‹è½½ (#4)

**ç¬¬äºŒæ³¢ (P1)** â€” ä½“éªŒæå‡:
4. Markdown Card å‘é€ (#6)
5. ç¾¤èŠå†å²å†…å­˜åŒ– (#7)
6. å‘é€è€…åç§°ç¼“å­˜ TTL (#8)
7. ç¾¤ç»„ç²¾ç»†é…ç½®è¿ç§» + bot å…¥ç¾¤è‡ªåŠ¨åŠ ç™½ (#9)
8. æ¶ˆæ¯åˆ†å—ä¼˜åŒ– (#14)

**ç¬¬ä¸‰æ³¢ (P2)** â€” å®Œå–„:
9. æƒé™é”™è¯¯æç¤º (#11)
10. Typing Indicator + è¶…æ—¶ (#12)

---

## å¾…ç¡®è®¤é¡¹

- [x] #3 ç»“æ„åŒ– endpoint æ–¹æ¡ˆ â†’ âœ… å·²ç¡®è®¤
- [x] #9 ç¾¤ç»„é…ç½®è¿ç§»æ–¹æ¡ˆ â†’ âœ… å·²ç¡®è®¤
- [x] Bot å…¥ç¾¤è‡ªåŠ¨åŠ ç™½ â†’ âŒ ä¸åšï¼ŒHoward ç¡®è®¤ä¸éœ€è¦
- [x] #9 ç¾¤èŠå‡†å…¥é€»è¾‘ â†’ âœ… å‚è€ƒ OpenClaw æ”¹é€ ï¼ˆgroupPolicy: open/allowlist/disabled + requireMention + per-group allowFromï¼‰

*å…¨éƒ¨ç¡®è®¤å®Œæ¯•ï¼Œå¼€å§‹æ‰§è¡Œã€‚*
